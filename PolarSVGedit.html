<!doctype html>
<html>
<head>
    <title>PolarSVGedit</title>
    <style>
body {
    background-color: #111;
    color: #eee;
    font-size: 1.2em;
    font-family: sans-serif;
}
input, select, button, label {
    font-size: inherit;
    font-family: inherit;
}
a {
    text-decoration: none;
}
div#container {
    display: flex;
    flex-wrap:wrap;
    justify-content: space-evenly;
    margin: 0.2em;
    border:0px solid black;
}
div#svgBox {
    background-color: rgba(240,240,240,0.9);
    background-image:
        linear-gradient(45deg, #eee 25%, transparent 0%, transparent 75%, #eee 25%, #eee),
        linear-gradient(45deg, #eee 25%, transparent 0%, transparent 75%, #eee 25%, #eee);
    background-size: 40px 40px;
    background-position: 0 0, 20px 20px;
    float: left;
    margin: 1em;
}
#svgCode {
    background-color: #222;
    font-size: 0.85em;
    color: #ccc;
    min-height: 20em;
    min-width: 72em;
    flex: 1;
    margin: 1em;
}
    </style>
</head>
<body onload="init()"  onkeydown="keydown(event)">
    <h1>PolarSVGedit</h1>
    <div id="options" style="background-color:rgba(127,127,255,0.3); display: flex; flex-flow: row wrap;">
        <h3 style="flex-basis: 100%; margin:0.3em;">Options:</h3>
        <div style="background-color:rgba(127,127,255,0.3); margin:0.3em; padding:0.3em; display: flex; flex-flow: row wrap;">
            <div>
                <label for="width">width:</label>
                <input type="text" id="width" name="width" value="800" style="width:3em" />
                * <label for="height">height:</label>
                <input type="text" id="height" name="height" value="600" style="width:3em" />
                <button onclick="setSvgSize()">set SVG-size</button>
            </div>&nbsp;&nbsp;|&nbsp;&nbsp;
            <div>
                <label for="snapGrid">snap-grid:</label>
                <input type="radio" id="grid40" name="snapGrid" onchange="setGrid(40)" />
                <label for="grid20">40</label>
                <input type="radio" id="grid20" name="snapGrid" onchange="setGrid(20)" />
                <label for="grid20">20</label>
                <input type="radio" id="grid10" name="snapGrid" onchange="setGrid(10)" checked />
                <label for="grid10">10</label>
                <input type="radio" id="grid5" name="snapGrid" onchange="setGrid(5)" />
                <label for="grid5">5</label>
                <input type="radio" id="grid2" name="snapGrid" onchange="setGrid(2)" />
                <label for="grid1">2</label>
                <input type="radio" id="grid1" name="snapGrid" onchange="setGrid(1)" />
                <label for="grid1">1</label>
            </div>
        </div>
        <div style="background-color:rgba(127,255,127,0.3); margin:0.3em; padding:0.3em; display: flex; flex-flow: row wrap;">
            <div>
                <label for="lineColor">line:</label>
                <input type="color" id="lineColor" name="lineColor" onchange="setLineColor(this.value)" />
            </div>&nbsp;&nbsp;|&nbsp;&nbsp;
            <div>
                <label for="strokeWidth">width:</label>
                <input type="radio" id="width10" name="strokeWidth" onchange="setWidth(10)" />
                <label for="width10">10</label>
                <input type="radio" id="width5" name="strokeWidth" onchange="setWidth(5)" />
                <label for="width5">5</label>
                <input type="radio" id="width3" name="strokeWidth" onchange="setWidth(3)" checked />
                <label for="width3">3</label>
                <input type="radio" id="width2" name="strokeWidth" onchange="setWidth(2)" />
                <label for="width2">2</label>
                <input type="radio" id="width1" name="strokeWidth" onchange="setWidth(1)" />
                <label for="width1">1</label>
                <input type="radio" id="width0" name="strokeWidth" onchange="setWidth(0)" />
                <label for="width1">0</label>
            </div>
            <div>&nbsp;&nbsp;|&nbsp;&nbsp;
                <label for="innerC">inner:</label>
                <input type="checkbox" id="innerC" name="innerC" onchange="setInnerColor(this.checked)" />
                <input type="color" id="innerColor" name="innerColor" onchange="setInnerColor(this.value)" />
            </div>
        </div>
    </div>
    <div id="tools" style="background-color:rgba(127,255,127,0.3); display: flex; flex-flow: row wrap;">
        <h3 style="flex-basis: 100%; margin:0.3em;">Tools:</h3>
        <div style="background-color:rgba(127,255,127,0.3); margin:0.3em; padding:0.3em; display: flex; flex-flow: row wrap; font-size:1.2em;">
            <div>
                <a class="aTool" id="aPath" onclick="setTool('path')" style="background-color:rgba(127,255,127,0.3)"><u>P</u>ath</a> | 
                <a class="aTool" id="aEllipse" onclick="setTool('ellipse')" style="background-color:rgba(127,255,127,0.3)"><u>E</u>llipse</a> | 
                <a class="aTool" id="aText" onclick="setTool('text')" style="background-color:rgba(127,255,127,0.3)"><u>T</u>ext</a>
            </div>
        </div>
        <div style="background-color:rgba(127,255,127,0.3); margin:0.3em; padding:0.3em; display: flex; flex-flow: row wrap;">
            <div>
                <label for="objectName">object id: </label>
                <input type="text" id="objectName" name="objectName" placeholder="(unique id)" onchange="objectName(this.value)" /> | 
                <label for="objectSelect">objects: </label>
                <select id="objectSelect" name="objectSelect" onchange="objectSelect(this.value)">
                    <option value="">edit attributes:</option>
                </select>
                <button onclick="alert('TODO: implement this; delete objects in the code for now!')">delete</button>
            </div>
        </div>
    </div>
    <div id="toolOptions" style="background-color:rgba(255,255,127,0.3); display: flex; flex-flow: row wrap; padding: 0.2em;">
        <i>(Tool-Options)</i>
    </div>
    <div id="container">
        <div id="svgBox" onclick="draw(event)" oncontextmenu="drawDone(event)" onmousemove="mousePreview(event)" onmouseleave="mousePreviewClear()">
        </div>
        <textarea id="svgCode" oninput="svgTypingPreview()"></textarea>
    </div>
    <hr style="clear:both;"/>
    <h2>(key-)controls</h2>
    <ul>
        <li>select tool with underlined key</li>
        <li>draw with arrow-keys and space, <a onclick="draw('','','',true)" style="text-decoration: underline;">close path with z</a></li>
        <li>refresh page for a fresh start (loosing all unsaved changes!)</li>
        <li><code>ctrl+z</code> will <a onclick="undo()" style="text-decoration: underline;">undo your last change</a>(s)</li>
        <li><code>ctrl+o</code> will <a onclick="loadFromFile()" style="text-decoration: underline;">load SVG-code from a file</a></li>
        <li><code>ctrl+s</code> will <a onclick="saveToFile()" style="text-decoration: underline;">download your SVG as a file</a></li>
    </ul>
    <hr style="clear:both;" />
    
<script>
var svgBox = document.getElementById('svgBox');
var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
var svgOld = [];
var svgCode = document.getElementById('svgCode');
var grid = 10
var actObj = null;
var strokeWidth = 3;
var fontSize = '20';
var lineColor = '#000000';
var innerColor = 'none';
var tool = '';
var toolOption = '';
var oldXY = [0,0];
var toolXY = [-1,-1];
function setSvgSize() {
    // set size of new or existing svg
    let width = document.getElementById('width').value;
    let height = document.getElementById('height').value;
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.setAttribute('viewBox', '0 0 '+width+' '+height);
    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
    //svg.appendChild(rect); //background
    svgBox.style.width = width+'px';
    svgBox.style.height = height+'px';
    // show:
    svgBox.appendChild(svg);
    svgCode.value = svg.outerHTML.replaceAll('>', '>\n').replaceAll('\n\n', '\n'); // micro-tidy
}
function init() {
    // init default settings
    setSvgSize();
    document.getElementById('grid'+grid.toString()).checked = true;
    document.getElementById('width'+strokeWidth.toString()).checked = true;
    document.getElementById('lineColor').value = lineColor;
    if (innerColor == 'none') {
        document.getElementById('innerC').checked = false;
        document.getElementById('innerColor').value = '#ffffff';
    } else {
        document.getElementById('innerC').checked = true;
        document.getElementById('innerColor').value = innerColor;
    }
    document.getElementById('objectName').value = null;
}
function setGrid(g) {
    // set snapping grid size
    grid = parseInt(g);
}
function setLineColor() {
    // set line color for active and new objects
    lineColor = document.getElementById('lineColor').value;
    if (actObj != null) {
        if ((actObj.nodeName == 'path') || (actObj.nodeName == 'ellipse')) {
            actObj.setAttribute('stroke', lineColor);
        } else if ((actObj.nodeName == 'text')) {
            actObj.setAttribute('fill', lineColor);
        }
    }
}
function setInnerColor(value) {
    // set fill color for active and new drawing objects
    console.log(value)
    if (value == true) {
        document.getElementById('innerC').checked = true;
        innerColor = document.getElementById('innerColor').value;
    } else if (value == false) {
        innerColor = 'none';
        document.getElementById('innerC').checked = false;
    } else {
        innerColor = value;
        document.getElementById('innerColor').value = value;
        document.getElementById('innerC').checked = true;
    }
    if (actObj != null) {
        if ((actObj.nodeName == 'path') || (actObj.nodeName == 'ellipse')) {
            actObj.setAttribute('fill', innerColor);
        }
    }
}
function setWidth(sw) {
    // set stroke-width for line tools
    strokeWidth = sw;
    if (actObj != null) {
        if ((actObj.nodeName == 'path') || (actObj.nodeName == 'ellipse')) {
            actObj.setAttribute('stroke-width', strokeWidth);
        }
    }
}
function setFontSize(size) {
    // set font-size for text-tool
    fontSize = size;
}
function setToolOption(o) {
    // set tool-options (for path-tool)
    toolOption = o;
    if (tool == 'path') {
        document.getElementById(tool+o.toUpperCase()).checked = true;
        if (o == 'q') {
            document.getElementById('toolHint').innerHTML = ' || <i>click-order Quadratic Bezier: [start,] end, controlpoint[, end2, ...]</i>';
        } else if (o == 'a') {
            document.getElementById('toolHint').innerHTML = ' || <i>usage for Arc: type is circular; clicks: [start,] end, r</i>';
        } else {
            document.getElementById('toolHint').innerHTML = '';
        }
    } else {
        document.getElementById('toolOptions').innerHTML = '<i>(Tool-Options)</i>';
    }
}
function setTool(t) {
    // set tool to be used ('path', 'ellipse', 'text' or '' for none)
    tool = t;
    toolXY = [0,0];
    let i=1;
    if (t=='path') {
        document.getElementsByClassName('aTool')[0].style.backgroundColor = 'rgba(127,255,127,0.6)';
        document.getElementsByClassName('aTool')[1].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[2].style.backgroundColor = 'rgba(127,255,127,0.3)';
        actObj = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        while (document.getElementById('path'+i)!=null) i++;
        actObj.setAttribute('id', 'path'+i);
        actObj.setAttribute('stroke', lineColor);
        actObj.setAttribute('stroke-width', strokeWidth);
        actObj.setAttribute('fill', innerColor);
        document.getElementById('objectName').value = actObj.id;
        let tO = document.getElementById('toolOptions');
        tO.innerHTML = '<input type="radio" id="pathM" name="pathOption" onchange="setToolOption(`m`)" checked />';
        tO.innerHTML += '<label for="pathM"><u>M</u>ove To</label> | ';
        tO.innerHTML += '<input type="radio" id="pathL" name="pathOption" onchange="setToolOption(`l`)" checked />';
        tO.innerHTML += '<label for="pathL"><u>L</u>ine</label> | ';
        tO.innerHTML += '<input type="radio" id="pathQ" name="pathOption" onchange="setToolOption(`q`)" />';
        tO.innerHTML += '<label for="pathQ"><u>Q</u>uadratic Bezier</label> | ';
        tO.innerHTML += '<input type="radio" id="pathA" name="pathOption" onchange="setToolOption(`a`)" />';
        tO.innerHTML += '<label for="pathQ"><u>A</u>rc</label>';
        tO.innerHTML += '<input type="checkbox" id="pathALarge" name="pathALarge" />';
        tO.innerHTML += '<label for="pathALarge">large</label>';
        tO.innerHTML += '<input type="checkbox" id="pathAClockwise" name="pathAClockwise" checked />';
        tO.innerHTML += '<label for="pathALong">clockwise</label>';
        tO.innerHTML += '<span id="toolHint"></span>'
        toolOption = 'l';
    }
    else if (t=='ellipse') {
        document.getElementsByClassName('aTool')[0].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[1].style.backgroundColor = 'rgba(127,255,127,0.6)';
        document.getElementsByClassName('aTool')[2].style.backgroundColor = 'rgba(127,255,127,0.3)';
        actObj = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
        while (document.getElementById('ellipse'+i)!=null) i++;
        actObj.setAttribute('id', 'ellipse'+i);
        actObj.setAttribute('stroke', lineColor);
        actObj.setAttribute('stroke-width', strokeWidth);
        actObj.setAttribute('fill', innerColor);
        document.getElementById('objectName').value = actObj.id;
        let tO = document.getElementById('toolOptions');
        tO.innerHTML = '<i>First click: center, next click(s): bounding-corner</i>';
        toolOption = '';
    }
    else if (t=='text') {
        document.getElementsByClassName('aTool')[0].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[1].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[2].style.backgroundColor = 'rgba(127,255,127,0.6)';
        actObj = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        while (document.getElementById('text'+i)!=null) i++;
        actObj.setAttribute('id', 'text'+i);
        actObj.setAttribute('text-anchor', 'right');
        actObj.setAttribute('fill', lineColor);
        actObj.setAttribute('font-size', fontSize);
        document.getElementById('objectName').value = actObj.id;
        let tO = document.getElementById('toolOptions');
        tO.innerHTML = '<input type="text" id="textContens" placeholder="text" /> | ';
        tO.innerHTML += '<input type="range" id="fontSize" onchange="setFontSize(this.value)" value="'+fontSize+'" min="8" max="64" oninput="this.nextElementSibling.value = this.value">';
        tO.innerHTML += '<output>'+fontSize+'px</output>'
        tO.innerHTML += ' || <i>specials chars like &Delta;&lambda; can be created with html-codes (<code>&</code><code>Delta</code><code>;</code>...)</i>'
        toolOption = 'text';
        document.getElementById('textContens').focus();
    } else {
        tool = '';
        document.getElementsByClassName('aTool')[0].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[1].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[2].style.backgroundColor = 'rgba(127,255,127,0.3)';
        setToolOption('');
        toolXY = [-1,-1];
    }
    oldXY = [0,0];
    mousePreviewClear()
}
function objectName(oName) {
    // set id of active object
    svgDom = new DOMParser().parseFromString(svg.innerHTML, 'text/xml');
    // TODO: check for allowed value with RegEx
    let exists = false;
    let idList = [];
    let children = svgDom.children;
    for (var i=0; i<children.length; i++) {
        if (oName == children[i].id) {
            alert('id `'+oName+'` exists already!');
            exists = true;
            break;
        } else {
            idList.push(children[i].id);
        }
    }
    if (!exists) {
        let oS = document.getElementById('objectSelect');
        for (var i=0; i<oS.options.length; i++) {
            if (oS.options[i].value == actObj.id) {
                oS.options[i].value = oName;
                oS.options[i].innerHTML = oName;
                oS.value = oName;
            }
        }
        actObj.id = oName;
    }
    svgBox.replaceChild(svg, svgBox.firstChild);
    svgCode.value = svg.outerHTML.replaceAll('>', '>\n').replaceAll('\n\n', '\n'); // micro-tidy
}
function objectSelect(oId) {
    // selecting old objects; only for attribute changes since coordinate are not remembered
    actObj = document.getElementById(oId);
    document.getElementById('objectName').value = actObj.id;
    setTool('');
    oldXY = [0,0];
    if (actObj.nodeName == 'path' || actObj.nodeName == 'ellipse') {
        lineColor = actObj.getAttribute('stroke'); // actObj.stroke works only with html-objects
    } else if (actObj.nodeName = 'text') {
        document.getElementsByClassName('aTool')[0].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[1].style.backgroundColor = 'rgba(127,255,127,0.3)';
        document.getElementsByClassName('aTool')[2].style.backgroundColor = 'rgba(127,255,127,0.6)';
        lineColor = actObj.getAttribute('fill');
        let tO = document.getElementById('toolOptions');
        tO.innerHTML = '<input type="text" id="textContens" value="'+actObj.innerHTML+'" /> | ';
        tO.innerHTML += '<input type="range" id="fontSize" onchange="setFontSize(this.value)" value="'+actObj.getAttribute('font-size')+'" min="8" max="64" oninput="this.nextElementSibling.value = this.value">';
        tO.innerHTML += '<output>'+actObj.getAttribute('font-size')+'px</output>'
        tO.innerHTML += ' || <i>specials chars like &Delta;&lambda; can be created with html-codes (<code>&</code><code>Delta</code><code>;</code>...)</i>'
        tool = 'text';
        toolOption = 'text';
    }
    document.getElementById('lineColor').value = lineColor;
}
function drawPath(x, y, z) {
    // draw path with path-tool
    let path = actObj;
    let pathNew = path;
    let dx = x-oldXY[0];
    let dy = y-oldXY[1];
    if (!path.hasAttribute('d')) {
        path.setAttribute('d', 'M '+x+','+y);
        oldXY = [x,y];
    }
    // close path
    else if (z) {
        pathNew.setAttribute('d', path.getAttribute('d')+' z');
        setTool('');
    }
    // m: Move To:
    else if (toolOption=='m') {
        pathNew.setAttribute('d', path.getAttribute('d')+' m '+dx+' '+dy);
        setToolOption('l');
        document.getElementById('pathL').checked = true;
        oldXY = [x,y];
    }
    // q: Quadratic Bezier:
    else if (toolOption=='q') {
        if (oldXY.length==2) {
            // set end-coordinates first
            oldXY.push(x);
            oldXY.push(y);
        } else if (oldXY.length==4) {
            // set control point and draw
            pathNew.setAttribute('d', path.getAttribute('d')+' q '+dx+' '+dy+','+(oldXY[2]-oldXY[0])+' '+(oldXY[3]-oldXY[1]));
            oldXY = [oldXY[2],oldXY[3],'t'];
        } else if (oldXY.length==3) {
            // continue with svg inferred control points
            pathNew.setAttribute('d', path.getAttribute('d')+' t '+dx+' '+dy);
            oldXY = [x,y,'t'];
        }
    }
    // a: arc: (limited to circular arcs)
    else if (toolOption=='a') {
        if (oldXY.length==2) {
            // set end-coordinates first
            oldXY.push(x);
            oldXY.push(y);
        } else {
            // set center of circular arc and draw
            let r = Math.round(Math.sqrt(Math.pow(oldXY[0]-x,2)+Math.pow(oldXY[1]-y,2)));
            if (document.getElementById('pathALarge').checked) {
                var large = 1;
            } else {
                var large = 0;
            }
            if (document.getElementById('pathAClockwise').checked) {
                var clockwise = 1;
            } else {
                var clockwise = 0;
            }
            pathNew.setAttribute('d', path.getAttribute('d')+' a '+r+' '+r+' 0 '+large+' '+clockwise+' '+(oldXY[2]-oldXY[0])+' '+(oldXY[3]-oldXY[1]));
            oldXY = [oldXY[2],oldXY[3]];
        }
    }
    // l: Line To:
    else {
        if ( dx==0 ) {
            pathNew.setAttribute('d', path.getAttribute('d')+' v '+dy);
        } else if (dy == 0) {
            pathNew.setAttribute('d', path.getAttribute('d')+' h '+dx);
        } else {
            pathNew.setAttribute('d', path.getAttribute('d')+' l '+dx+' '+dy);
        }
        oldXY = [x,y];
    }
    //svg.replaceChild(pathNew, path);
}
function drawEllipse(x, y) {
    // draw ellipse with ellipse-tool
    let ellipse = actObj;
    if (!ellipse.hasAttribute('cx')) {
        ellipse.setAttribute('cx', x);
        ellipse.setAttribute('cy', y);
    } else {
        let rx = Math.abs(ellipse.getAttribute('cx')-x);
        let ry = Math.abs(ellipse.getAttribute('cy')-y);
        if (rx==0) rx=strokeWidth/2;
        if (ry==0) ry=strokeWidth/2;
        ellipse.setAttribute('rx', rx);
        ellipse.setAttribute('ry', ry);
        setTool('ellipse');
    }
}
function drawText(x, y) {
    // draw text with text-tool
    let t = document.getElementById('textContens').value;
    if (t != '') {
        let text = actObj;
        text.setAttribute('x', x);
        text.setAttribute('y', y);
        text.setAttribute('font-size', fontSize);
        text.innerHTML = t;
        setTool('text');
    }
}
function mousePreview(e, px=-1, py=-1) {
    // show preview of the object to be drawn on mousemove
    if ((tool != 'path') && (tool != 'ellipse') && (tool != 'text')) {
        return;
    }
    let mBound = svgBox.getBoundingClientRect();
    if (px==-1) { px = Math.round((e.clientX-mBound.left)/grid)*grid };
    if (py==-1) { py = Math.round((e.clientY-mBound.top)/grid)*grid };
    var pre = document.getElementById('preview');
    if (tool == 'path') {
        // preview for path-tool
        if (!pre) {
            var pre = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pre.setAttribute('stroke', '#888');
            pre.setAttribute('stroke-width', '4');
            pre.setAttribute('d', 'M '+(px-2)+','+py+' L '+(px+2)+','+py);
        }
        pre.setAttribute('stroke-width', '2');
        if (actObj.hasAttribute('d')) {
            // m: Move To:
            if (toolOption=='m') {
                // just show a point
                pre.setAttribute('stroke-width', '4');
                pre.setAttribute('d', 'M '+(px-2)+','+py+' L '+(px+2)+','+py);
            }
            // q: Quadratic Bezier:
            else if (toolOption=='q') {
                pre.setAttribute('fill', 'none');
                if (oldXY.length==2) {
                    // show point for end-coordinates
                    pre.setAttribute('stroke-width', '4');
                    pre.setAttribute('d', 'M '+(px-2)+','+py+' L '+(px+2)+','+py);
                } else if (oldXY.length==4) {
                    // set control point and draw
                    pre.setAttribute('d', 'M '+oldXY[0]+','+oldXY[1]+' q '+(px-oldXY[0])+' '+(py-oldXY[1])+','+(oldXY[2]-oldXY[0])+' '+(oldXY[3]-oldXY[1]));
                } else if (oldXY.length==3) {
                    // continue with svg inferred control points: can only show point
                    pre.setAttribute('stroke-width', '4');
                    pre.setAttribute('d', 'M '+(px-2)+','+py+' L '+(px+2)+','+py);
                }
            }
            // a: arc:
            else if (toolOption=='a') {
                if (oldXY.length==2) {
                    // set end-coordinates first
                    pre.setAttribute('stroke-width', '4');
                    pre.setAttribute('d', 'M '+(px-2)+','+py+' L '+(px+2)+','+py);
                } else {
                    pre.setAttribute('fill', 'none');
                    // set center of circular arc and draw
                    let pr = Math.round(Math.sqrt(Math.pow(oldXY[0]-px,2)+Math.pow(oldXY[1]-py,2)));
                    if (document.getElementById('pathALarge').checked) {
                        var plarge = 1;
                    } else {
                        var plarge = 0;
                    }
                    if (document.getElementById('pathAClockwise').checked) {
                        var pclockwise = 1;
                    } else {
                        var pclockwise = 0;
                    }
                    pre.setAttribute('d', 'M '+oldXY[0]+','+oldXY[1]+' a '+pr+' '+pr+' 0 '+plarge+' '+pclockwise+' '+(oldXY[2]-oldXY[0])+' '+(oldXY[3]-oldXY[1]));
                }
            }
            // l: Line To:
            else {
                pre.setAttribute('d', 'M '+oldXY[0]+','+oldXY[1]+' L '+px+','+py);
            }
        }
        else {
            pre.setAttribute('stroke-width', '4');
            pre.setAttribute('d', 'M '+(px-2)+','+py+' L '+(px+2)+','+py);
        }
    }
    else if (tool == 'ellipse') {
        // preview for ellipse-tool
        if (!pre) {
            var pre = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
            pre.setAttribute('stroke', '#888');
            pre.setAttribute('fill', 'none');
            pre.setAttribute('stroke-width', '2');
        }
        if (actObj.hasAttribute('cx')) {
            pre.setAttribute('cx', actObj.cx.baseVal.value);
            pre.setAttribute('cy', actObj.cy.baseVal.value);
            let prx = Math.abs(actObj.getAttribute('cx')-px);
            let pry = Math.abs(actObj.getAttribute('cy')-py);
            if (prx==0) prx=strokeWidth/2;
            if (pry==0) pry=strokeWidth/2;
            pre.setAttribute('rx', prx);
            pre.setAttribute('ry', pry);
        } else {
            pre.setAttribute('cx', px);
            pre.setAttribute('cy', py);
            pre.setAttribute('rx', '2');
            pre.setAttribute('ry', '2');
        }
    }
    else if (tool == 'text') {
        // preview for text-tool
        if (!pre) {
            var pre = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            pre.setAttribute('text-anchor', 'right');
            pre.setAttribute('fill', '#888');
        }
        pre.setAttribute('x', px);
        pre.setAttribute('y', py);
        pre.setAttribute('font-size', fontSize);
        pre.innerHTML = document.getElementById('textContens').value;
    }
    pre.setAttribute('id', 'preview');
    svg.appendChild(pre);
}
function mousePreviewClear() {
    // remove mouse-preview from svg
    let preview = document.getElementById('preview');
    if (preview) {
        svg.removeChild(preview);
    }
}
function svgTypingPreview() {
    // shows the svg if possible upon code edits
    let parser = new DOMParser();
    let svgcode = document.getElementById('svgCode').value;
    try{
        let svgNewDoc = parser.parseFromString(svgcode, 'image/svg+xml');
        const errorNode = svgNewDoc.querySelector('parsererror');
        if (errorNode) {
            console.log(errorNode);
        } else {
            svgOld.push(svg.innerHTML);
            svg.innerHTML = svgNewDoc.documentElement.innerHTML;
            svgBox.replaceChild(svg, svgBox.firstChild);
        }
    } catch (error) {
        console.log(error);
    }
    //document.getElementById('svgView').innerHTML = svg;
}
function draw(e, x=-1, y=-1, z=false) {
    // draw-event on mouse-click in svg-box
    let created = false;
    if (actObj == null) {
        alert('Choose tool first!');
        return;
    }
    let element = document.getElementById(actObj.id);
    if (!element) {
        svg.appendChild(actObj);
        created = true;
    }
    let bound = svgBox.getBoundingClientRect();
    if (x==-1) { x = Math.round((e.clientX-bound.left)/grid)*grid; }
    if (y==-1) { y = Math.round((e.clientY-bound.top)/grid)*grid; }
    toolXY = [x,y];
    svgOld.push(svg.innerHTML);
    if (tool=='path') {
        drawPath(x, y, z);
    } else if (tool=='ellipse') {
        drawEllipse(x, y);
    } else if (tool=='text') {
        drawText(x, y);
    } else {
        return;
    }
    if (created) {
        // add object to object-select-list
        let opt = document.createElement('option');
        opt.value = actObj.id;
        opt.innerHTML = actObj.id;
        document.getElementById('objectSelect').append(opt);
        document.getElementById('objectSelect').value = opt.value;
    }
    // show:
    mousePreviewClear();
    svgBox.replaceChild(svg, svgBox.firstChild);
    svgCode.value = svg.outerHTML.replaceAll('>', '>\n').replaceAll('\n\n', '\n'); // micro-tidy
}
function drawDone(e) {
    if (e) { e.preventDefault(); }
    setTool('');
}
function undo() {
    // undo the latest change on active object; will deselect active tool due to missing coordinates to continue drawing
    let innerHTML = svgOld.pop();
    if (innerHTML != null) {
        svg.innerHTML = innerHTML;
        svgBox.replaceChild(svg, svgBox.firstChild);
        actObj = null;
        setTool('');
        document.getElementById('toolOptions').innerHTML = '(no tool selected)';
        svgCode.value = svg.outerHTML.replaceAll('>', '>\n').replaceAll('\n\n', '\n'); // micro-tidy
    }
}
function loadFromFile() {
  let input = document.createElement('input');
  input.type = 'file';
  input.onchange = _ => {
            let file = Array.from(input.files)[0];
            if (file) {
                let reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = function (evt) {
                    try{
                        let parser = new DOMParser();
                        let svgNewDoc = parser.parseFromString(evt.target.result, 'image/svg+xml');
                        let svgcode = svgNewDoc.documentElement.innerHTML;
                        const errorNode = svgNewDoc.querySelector('parsererror');
                        if (errorNode) {
                            alert('Error reading file');
                            console.log(errorNode);
                            return;
                        } else {
                            svgOld.push(svg.innerHTML);
                            svg.innerHTML = svgNewDoc.documentElement.innerHTML;
                            svgCode.value = svg.outerHTML.replaceAll('>', '>\n').replaceAll('\n\n', '\n'); // micro-tidy
                            svgBox.replaceChild(svg, svgBox.firstChild);
                        }
                    } catch (error) {
                        alert('Error reading file');
                        console.log(error);
                        return;
                    }
                }
                reader.onerror = function (evt) {
                    alert('Error reading file');
                    return;
                }
            }
            
        };
  input.click();
}
function saveToFile() {
    // save svg-file to client
    var base64doc = btoa(unescape(encodeURIComponent(svg.outerHTML))),
        a = document.createElement('a'),
        e = new MouseEvent('click');
    a.download = 'svgDrawing.svg';
    a.href = 'data:image/svg+xml;base64,' + base64doc;
    a.dispatchEvent(e);
}
function keydown(e) {
    // catch relevant key-presses for controls like tool selects etc.
    var evtobj = window.event? event : e
    if (evtobj.keyCode == 90 && evtobj.ctrlKey) {
        undo();
    } else if (String.fromCharCode(evtobj.keyCode)=='O' && evtobj.ctrlKey) {
        e.preventDefault();
        loadFromFile();
    } else if (String.fromCharCode(evtobj.keyCode)=='S' && evtobj.ctrlKey) {
        e.preventDefault();
        saveToFile();
    } else if ( // keep key-functions if needed i.e. for typing
            (document.activeElement != document.getElementById('textContens')) && 
            (document.activeElement != document.getElementById('svgCode')) && 
            (document.activeElement != document.getElementById('objectName'))
            ) {
        if (String.fromCharCode(evtobj.keyCode)=='P') {
            setTool('path');
        } else if (String.fromCharCode(evtobj.keyCode)=='E') {
            setTool('ellipse');
        } else if (String.fromCharCode(evtobj.keyCode)=='T') {
            e.preventDefault();
            setTool('text');
            document.getElementById('textContens').value = '';
        } else if (String.fromCharCode(evtobj.keyCode)=='M' && tool=='path') {
            setToolOption('m');
        } else if (String.fromCharCode(evtobj.keyCode)=='L' && tool=='path') {
            setToolOption('l');
        } else if (String.fromCharCode(evtobj.keyCode)=='Q' && tool=='path') {
            setToolOption('q');
        } else if (String.fromCharCode(evtobj.keyCode)=='A' && tool=='path') {
            setToolOption('a');
        } else if (String.fromCharCode(evtobj.keyCode)=='Z' && tool=='path') {
            draw('', '', '', z=true);
        } else if (e.code == 'ArrowLeft' && toolXY[0] >= grid) {
            e.preventDefault();
            toolXY[0] = toolXY[0]-grid;
            mousePreview('',toolXY[0],toolXY[1])
        } else if (e.code == 'ArrowUp' && toolXY[1] >= grid) {
            e.preventDefault();
            console.log(toolXY);
            toolXY[1] = toolXY[1]-grid;
            mousePreview('',toolXY[0],toolXY[1])
        } else if (e.code == 'ArrowRight') {
            e.preventDefault();
            toolXY[0] = toolXY[0]+grid;
            mousePreview('',toolXY[0],toolXY[1])
        } else if (e.code == 'ArrowDown') {
            e.preventDefault();
            toolXY[1] = toolXY[1]+grid;
            mousePreview('',toolXY[0],toolXY[1])
        } else if (e.code == 'Space') {
            e.preventDefault();
            draw('',toolXY[0],toolXY[1])
        } else if (e.code == 'Enter') {
            e.preventDefault(e);
            drawDone();
        }
    }
}
</script>

<h2>Basics for <code>SVG</code>-coding</h2>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/SVG" target="_blank">Mozilla-SVG-Documentation</a></p>
<details><summary>Snippets</summary>
    <table style="border:1px solid black;">
        <tr>
            <th style="width:15%">Object</th>
            <th style="width:15%">Example</th>
            <th style="width:40%">Code</th>
            <th style="width:30%">Info</th>
        </tr>
        <tr>
            <td>Circle</td>
            <td><svg><circle cx="100" cy="100" r="30" fill="red" /></svg></td>
            <td><code>&lt;circle cx="100" cy="100" r="30" fill="red" /&gt;</code></td>
            <td></td>
        </tr>
        <tr>
            <td>Ellipse</td>
            <td><svg><ellipse cx="100" cy="50" rx="60" ry="30" fill="green"/></svg></td>
            <td><code>&lt;ellipse cx="100" cy="50" rx="60" ry="30" fill="green"/&gt;</code></td>
            <td></td>
        </tr>
        <tr>
            <td>Rectangle</td>
            <td><svg><rect x="50" y="50" width="100" height="75" fill="#FF0" stroke="#000" stroke-width="10" /></svg></td>
            <td><code>&lt;rect x="50" y="50" width="100" height="75" fill="#FF0" stroke="#000" stroke-width="10" /&gt;</code></td>
            <td></td>
        </tr>
        <tr>
            <td>Path</td>
            <td><svg><path d="M 10,100 L 50,50 v 50 h 70 c 0 0 30 0 30 -50" fill="none" stroke="rgb(255,153,102)" stroke-width="2"/></svg></td>
            <td><code>&lt;path d="M 10,100 L 50,50 v 50 h 70 c 0 0 30 0 30 -50" fill="none" stroke="rgb(255,153,102)" stroke-width="2"/&gt;</code></td>
            <td>
                <ul>
                <li>M = moveto</li>
                <li>L = lineto</li>
                <li>H = horizontal lineto</li>
                <li>V = vertical lineto</li>
                <li>C = curveto</li>
                <li>S = smooth curveto</li>
                <li>Q = quadratic Bézier curve</li>
                <li>T = smooth quadratic Bézier curveto</li>
                <li>A = elliptical Arc</li>
                <li>Z = closepath</li>
                </ul>
                CAPS: absolute; lower: relative
            </td>
        </tr>

        <tr>
            <td>Path: Arc</td>
            <td><svg><path d="M 50 50 A 10 40 0 0 0 70 50 A 5 40 0 0 0 60 50 A 10 40 0 0 0 80 50" stroke="red" fill="none" /></svg></td>
            <td><code>&lt;path d="M 50 50 A 10 40 0 0 0 70 50 A 5 40 0 0 0 60 50 A 10 40 0 0 0 80 50" stroke="red" fill="none" /&gt;</code></td>
            <td>
                <p>Meaning of the numbers:</p>
                <ol>
                    <li>M: moveto</li>
                    <li>85: x-startpoint</li>
                    <li>350: y-startpoint</li>
                    <li>A: arc (caps: Absolut)</li>
                    <li>150: radius x-Axis</li>
                    <li>180: radius y-Axis</li>
                    <li>0: rotation x</li>
                    <li>0: flag short (0) or long (1) was</li>
                    <li>0: flag counter-clockwise</li>
                    <li>280: x-endpoint</li>
                    <li>79: y-endpoint</li>
                </ol>
                CAPS: absolute; lower: relative
            </td>
        </tr>
        <tr>
            <td>Bezier-path (quadratic)</td>
            <td><svg>
                <path d="M 100,10 Q 10,50 200,150" fill="none" stroke="blue"/>
                <path d="M 100,10 10,50 200,150" fill="none" stroke="gray"/>
            </svg></td>
            <td><code>
                &lt;path d="M 100,10 Q 10,50 200,150" fill="none" stroke="blue"/&gt;<br />
                &lt;path d="M 100,10 10,50 200,150" fill="none" stroke="gray"/&gt;
            </code></td>
            <td></td>
        </tr>
        <tr>
            <td>Text</td>
            <td><svg><text x="20" y="50" text-anchor="right" fill="currentColor">Testtext x<tspan dy="-0.4em" font-size="0.6em">2</tspan></text></svg></td>
            <td><code>&lt;text x="20" y="50" text-anchor="right" fill="currentColor"&gt;Testtext x&lt;tspan dy="-0.4em" font-size="0.6em"&gt;2&lt;/tspan&gt;&lt;/text&gt;</code></td>
            <td></td>
        </tr>
    </table>
    <h3>Example</h3>
    <img src="./../../../_static/test.svg" alt="svg-testimage" width="800" height="600" />
</details>
<details><summary>Symbols</summary>
    <p><i>Hint: This details-page makes use of the deprecated <code>&lt;xmp&gt;</code>-tag. Let's hope that browsers keep supporting it.</i></p>
    <p>Use these i.e. with: <code>&lt;use href="#measure" x="100" y="200"/&gt;</code></p>
    <table style="border:1px solid black;">
        <tr>
            <th>Symbol</th>
            <th>Example</th>
            <th>Code</th>
        </tr>
        <tr>
            <td>Arrowhead</td>
            <td><svg>
<defs>
    <marker id="arrow" markerWidth="5" markerHeight="6" refX="4" refY="3" orient="auto-start-reverse">
        <polygon points="0 0,5 3,0 6, 2 3"/>
    </marker>
</defs>
<line x1="0" y1="20" x2="50" y2="20" stroke="#0a0" stroke-width="2" marker-start="url(#arrow)" marker-end="url(#arrow)"/></xmp>
            </svg></td>
            <td>
<xmp><defs>
    <marker id="arrow" markerWidth="5" markerHeight="6" refX="4" refY="3" orient="auto-start-reverse">
        <polygon points="0 0,5 3,0 6, 2 3"/>
    </marker>
</defs>
<line x1="0" y1="50" x2="250" y2="50" stroke="#0a0" stroke-width="2" marker-start="url(#arrow)" marker-end="url(#arrow)"/></xmp>
            </td>
        </tr>
        <tr>
            <td>Electron</td>
            <td><svg>
    <circle r="6" cx="7" cy="7" style="fill:none;stroke:blue;stroke-width:2"/>
    <path d="m 3,7 h 8" fill="none" stroke="blue" stroke-width="2"/>
            </svg></td>
            <td>
<xmp><symbol id="electron">
    <circle r="6" cx="7" cy="7" style="fill:none;stroke:blue;stroke-width:2"/>
    <path d="m 3,7 h 8" fill="none" stroke="blue" stroke-width="2"/>
</symbol></xmp>
            </td>
        </tr>
    </table>
</details>
<details><summary>Other</summary>
    <p><i>Hint: This details-page makes use of the deprecated <code>&lt;xmp&gt;</code>-tag. Let's hope that browsers keep supporting it.</i></p>
    <table style="border:1px solid black;">
        <tr>
            <th>What</th>
            <th>Example</th>
            <th>Code</th>
            <th>Info</th>
        </tr>
        <tr>
            <td>Formulas</td>
            <td>
<svg>
<foreignObject width="150" height="60" x="10" y="10" style="color:#0a0">
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline"><mrow><mi>E</mi><mo>&#x0003D;</mo><mi>m</mi><mo>&#x022C5;</mo><msup><mrow><msub><mi>c</mi><mn>0</mn></msub></mrow><mn>2</mn></msup></mrow></math>
</foreignObject>
</svg>
            </td>
            <td>
<xmp><foreignObject width="150" height="60" x="10" y="10" style="color:#0a0">
    <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
        <mrow><mi>E</mi><mo>&#x0003D;</mo><mi>m</mi><mo>&#x022C5;</mo><msup>
            <mrow><msub><mi>c</mi><mn>0</mn></msub>
        </mrow><mn>2</mn></msup>
    </mrow></math>
</foreignObject></xmp>
            </td>
            <td>The MathML-Code can be created with the mdTeX-Cheatsheet</td>
        </tr>
    </table>
</details>

<hr>
    <h2>TODO for development</h2>
    <h3>milestone</h3>
    <ul>
        <li><s>undo "ctrl+z"</s> done</li>
        <li><s>quick-key "m" or "q" for tool-options (and tools?)</s> done</li>
        <li><s>text</s> done</li>
        <li><s>bug: duplicate elements on duplicate clicks - remember active object for edit?</s> done</li>
        <li><s>change active element color on color-select</s> done</li>
        <li><s>save with `ctrl+s`</s> done</li>
        <li><s>get it working on chromium-engine</s> tested, seems to be working fine</li>
    </ul>
    <h3>optional ideas</h3>
    <ul>
        <li><s>Element-list with renaming-option!</s> done</li>
        <li><s>Element-list with continue-edit-option!</s> done (only attribute edits possible)</li>
        <li><s>fill-color ("none" must be selectable)</s> (not planned anymore)</li>
        <li><s>"h" and "v" in paths if applicable (and z?)</s> done</li>
        <li><s>arc in paths</s> done</li>
        <li><s>cubic bezier?</s> (not planned anymore)</li>
        <li><s>previews with mousemove?</s></li>
        <li><s>draw (paths) with arrow-keys and space (=click)? -> maybe some day, will move to a feature-request on going stable</s> done</li>
        <li><s>symbols like arrow-heads</s> (not planned anymore)</li>
        <li><s>mdTeX in text-elements?</s> would need a server; And some elements like &Delta;&lambda; can be created with html-codes (<code>&</code><code>Delta</code><code>;</code>...) as well.</li>
    </ul>

<hr />
<p>PolarSVGedit v0.9.2dev - (c) 2023 by Dirk Winkel - Licenced under GPL v3 or newer</p>

</body>

</html>
